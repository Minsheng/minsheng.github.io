<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pokemon Night</title>
    <style>
        body {
            background-color: #181818;
        }

        #scene_layer {
            z-index: 0;
        }

        #weather_layer {
            z-index: 2;
            position:absolute;
        }

        #container {
            text-align:center;
            position:relative;
        }

        #inner_container{
            position:relative;
        }
    </style>
    <script type="text/javascript">
        var raf;
        // initialize weather data
        const maxParticles = 120;
        const maxRadiusScale = 4.5;
        var particles_init = [];
        var particles = [];

        // constants for pokemon gif
        const maxPokemon = 20;
        const animatedPokemonWidth = 40;
        const animatedPokemonHeight = 40;
        const animatedPokemonXOffset = 15;
        const animatedPokemonYOffset = 15;
        var pokemonCollection = [];
        var animatedPokemonToAdd = [];

        // class for image of pokemon on canvas
        class Pokemon {
            constructor(ctx, name, x, y, w, h, src) {
                this.ctx = ctx;
                this.name = name;
                this.x = x;
                this.y = y;
                this.width = w;
                this.height = h;
                this.src = src;
            }

            draw() {
                var global = this;
                if (global.ctx) {
                    let pokemonImg = new Image();
                    pokemonImg.onload = function () {
                        console.log("draw image for "+ global.name);
                        global.ctx.drawImage(pokemonImg, global.x, global.y, global.width, global.height);
                    };
                    pokemonImg.src = global.src;
                }
            }
        }

        // class for image (gif) of pokemon directly added to DOM
        class AnimatedPokemon {
            constructor(name, x, y, w, h, src) {
                this.name = name;
                this.x = x;
                this.y = y;
                this.width = w;
                this.height = h;
                this.src = src;
            }
        }

        /* Draw objects on the canvas */
        function init() {
            var ctx_scene = document.getElementById('scene_layer').getContext('2d');
            var cw = ctx_scene.canvas.clientWidth; // canvas width
            var ch = ctx_scene.canvas.clientHeight; // canvas height

            if (ctx_scene) {
                // draw two pokemon images
                drawPokemon(ctx_scene, cw, ch);
                // draw the sun
                drawSceneObj(ctx_scene, cw, ch);

                // initialize particles for firefly effect
                for (var i = 0; i < maxParticles; i++) {
                    particles_init.push({
                        x: getRandomInt(0, cw),
                        y: getRandomInt(0, ch),
                        color: 'rgba(195, 255, 44, 0.8)',
                        radius: Math.random() * maxRadiusScale, // size of particles
                        xs: Math.random() * 1.5 + 0.55, // velocity x
                        ys: Math.random() * 1.5 + 0.75 // velocity y
                    })
                }

                for (var j = 0; j < maxParticles; j++) {
                    particles[j] = particles_init[j];
                }

                // draw animated fireflies
                drawWeather();
            }

            // initialize random pokemon image objects
            initPokemonCollection(cw, ch);

            // draw pokemon image objects
            drawMany(animatedPokemonToAdd);
        }

        /* Initialize a list of pokemon image objects with random position */
        function initPokemonCollection(max_w, max_h) {
            for (var i=0; i < maxPokemon; i++) {
                var x = getRandomInt(20, max_w);
                var y = getRandomInt(400, max_h*0.85);

                if (i > 0) {
                    if (Math.abs(animatedPokemonToAdd[i-1].x - x) <= 5) {
                        x += animatedPokemonXOffset;
                    }

                    if (Math.abs(animatedPokemonToAdd[i-1].y - y) <= 5) {
                        x += animatedPokemonYOffset;
                    }
                }

                if (getRandomInt(0,1)) {
                    let puff = new AnimatedPokemon('puff', x, y, animatedPokemonWidth, animatedPokemonHeight, 'http://media.pldh.net/pokemon/gen6/xy-animated/025.gif');
                    animatedPokemonToAdd.push(puff);
                } else {
                    let pikachu = new AnimatedPokemon('pikachu', x, y, animatedPokemonWidth, animatedPokemonHeight, 'http://media.pldh.net/pokemon/gen6/xy-animated/039.gif');
                    animatedPokemonToAdd.push(pikachu);
                }
            }
        }

        /* Add multiple images from the collection to the DOM */
        function drawMany(collection) {
            for (var i=0; i < collection.length; i++) {
                let pokemon = collection[i];
                createAnimatedImageEle(pokemon.src, pokemon.width, pokemon.height, pokemon.x, pokemon.y);
            }
        }

        /* Add an image with absolute position to the DOM */
        function createAnimatedImageEle(src, w, h, x, y) {
            var img = document.createElement("img");
            img.setAttribute('src', src);
            img.setAttribute('height', w.toString());
            img.setAttribute('width', h.toString());
            img.style.zIndex = '1';
            img.style.position = 'absolute';
            img.style.top = y.toString()+'px';
            img.style.left = x.toString()+'px';
            document.body.appendChild(img);
        }

        /* Returns a random integer between min and max
        * Reference from https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/random
        * */
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        /* Draw the sun / moon with glowing effect on the canvas
        * Referencing Drawing a ball, from https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Advanced_animations
        * */
        function drawSceneObj(ctx_scene, cw, ch) {
            var sun = {
                x: cw * 0.1,
                y: ch * 0.1,
                radius: 25,
                color: 'rgba(242,217,92,0.9)',
                draw: function (ctx_scene) {
                    ctx_scene.beginPath();
                    ctx_scene.arc(this.x, this.y, this.radius+20, 0, Math.PI*2, true);
                    ctx_scene.closePath();
                    ctx_scene.fillStyle = 'rgba(242,217,92,0.2)';
                    ctx_scene.fill();

                    ctx_scene.beginPath();
                    ctx_scene.arc(this.x, this.y, this.radius+10, 0, Math.PI*2, true);
                    ctx_scene.closePath();
                    ctx_scene.fillStyle = 'rgba(242,217,92,0.4)';
                    ctx_scene.fill();

                    ctx_scene.beginPath();
                    ctx_scene.arc(this.x, this.y, this.radius, 0, Math.PI*2, true);
                    ctx_scene.closePath();
                    ctx_scene.fillStyle = this.color;
                    ctx_scene.fill();
                }
            };

            sun.draw(ctx_scene);
        }

        /* Draw two pokemon images on the canvas */
        function drawPokemon(ctx_scene, cw, ch) {
            let puff = new Pokemon(ctx_scene, 'puff', cw*0.75, ch - 100, 80, 80, 'http://www.ssbwiki.com/images/thumb/a/a6/Jigglypuff_SSB4.png/250px-Jigglypuff_SSB4.png');
            let pikachu = new Pokemon(ctx_scene, 'pikachu', cw*0.85, ch - 100, 80, 80, 'http://origin.pokedex3d.com/assets/images/pokemon/pikachu.png');
            puff.draw();
            pikachu.draw();
        }

        /*
        * This function references Max Ruigewaard's Rain on HTML5 Canvas
        * https://codepen.io/ruigewaard/pen/JHDdF
        * I made a few changes,
        * - the particles are drawn as random size of circles instead of lines, like fireflies instead of rain
        * - the particles move upwards from the bottom,
        * - instead of using setInterval, I use requestAnimationFrame for automatic animation control
        * */
        function drawWeather() {
            let ctx = document.getElementById('weather_layer').getContext('2d');
            var cw = ctx.canvas.clientWidth; // canvas width
            var ch = ctx.canvas.clientHeight; // canvas height

            ctx.clearRect(0,0,cw,ch);

            for (var i = 0; i < particles.length; i++) {
                var p = particles[i];
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI*2, true);
                ctx.closePath();
                ctx.fillStyle = p.color;
                ctx.fill();
            }

            for (var j = 0; j < particles.length; j++) {
                var p = particles[j];
                p.x -= p.xs;
                p.y -= p.ys;
                if (p.x <= 0 || p.y <= 0) {
                    p.x = getRandomInt(0, cw);
                    p.y = getRandomInt(0, ch);
                }
            }
            raf = window.requestAnimationFrame(drawWeather);
        }
    </script>
</head>
<body onload="init();">
    <div id="container">
        <div id="inner_container">
            <!-- This layer renders the animated particles -->
            <canvas id="weather_layer" width="1200" height="620"></canvas>
            <!-- This layer renders the static objects including images and shapes -->
            <canvas id="scene_layer" width="1100" height="600"></canvas>
        </div>
    </div>
    <!-- Play some nature sound automatically, from Khao Yai Rainforest on soundcloud -->
    <iframe width="0%" height="0" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/264344114&amp;auto_play=true&amp;hide_related=false&amp;show_comments=true&amp;show_user=true&amp;show_reposts=false&amp;visual=true"></iframe>
</body>
</html>