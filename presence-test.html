<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Test presence</title>
        <style>
            .info {
                position: fixed;
                top: 0px;
                left: 0px;
                cursor: pointer;
                opacity: 0.9;
                z-index: 10000;
            }
        </style>
    </head>
    <body onload="justRunFam()">
        <div class="info">
            Current users: <span id="numUser">NaN</span>
            <div id="userdata"></div>
        </div>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
        <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.0.5.js"></script>
        <script type="text/javascript">
            /*
            Code sample from,
            https://www.pubnub.com/docs/javascript/api-reference-sdk-v4
            */
            class User {
                constructor(uuid, geoloc, position) {
                    this.uuid = uuid;
                    this.geoloc = geoloc;
                    this.position = position;
                }
            }

            var users = {};
            var currUuid = '';
            const MR_CHANNEL = 'mr-demo';
            const GEO_INTERVAL = 200;

            // geolocation config options
            const options = {
                timeout: (2 * 1000),
                maximumAge: 0,
                enableHighAccuracy: true
            };

            function justRunFam() {
                currUuid = generateUUID(); // generate a random id for the current user

                var pubnub = new PubNub({
                    publishKey: 'pub-c-d223f6bb-65ab-4128-b272-3984970759c1',
                    subscribeKey: 'sub-c-441be6a2-5d04-11e6-ada4-02ee2ddab7fe',
                    ssl: true,
                    uuid: currUuid,
                    heartbeatInterval: 5,
                    presenceTimeout: 60
                });

                pubnub.subscribe({
                    channels: [MR_CHANNEL],
                    withPresence: true
                });

                // View the UUID and state objects of those currently subscribed
                pubnub.hereNow(
                    {
                        channels: [MR_CHANNEL],
                        includeUUIDs: true,
                        includeState: true
                    },
                    function (status, response) {
                        // handle status, response
                        console.log("Here now:");
                        console.log(response);

                        if (response.channels[MR_CHANNEL]) {
                            var userList = response['channels'][MR_CHANNEL]['occupants'];
                            initializeUsers(userList);
                        }
                    }
                );

                pubnub.addListener({
                    status: function(statusEvent) {
                        if (statusEvent.category === "PNConnectedCategory") {
                            // var newState = {
                            //     isTyping: true
                            // };
                            // pubnub.setState(
                            //     {
                            //         state: newState
                            //     },
                            //     function (status) {
                            //         // handle state setting response
                            //         // console.log(status);
                            //     }
                            // );
                        }
                    },
                    message: function(m) {
                        // handle message
                        var data = m.message;

                        if (!jQuery.isEmptyObject(data) &&
                            data.uuid &&
                            !jQuery.isEmptyObject(data.geoloc)) {

                            // update geolocation only for other users
                            if (data.uuid !== currUuid) updatePosition(data);

                            showUserData();
                        }
                    },
                    presence: function(e) {
                        // handle presence event
                        // console.log("Presence of " + e.uuid + " :");
                        // console.log(e);
                        updateUsers(e);
                        showUserData();
                    }
                });

                //////////////////////////
                // Get geolocation
                //////////////////////////
                setInterval(function(){
                    refreshGeolocation();
                }, GEO_INTERVAL);

                function refreshGeolocation() {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(success, function() {
                            handleLocationError(true);
                        }, options);
                    } else {
                        // Browser doesn't support Geolocation
                        handleLocationError(false);
                    }
                }

                function success(position) {
                    var pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // update the geolocation of the current user
                    updatePosition({
                        uuid: currUuid,
                        geoloc: pos
                    });

                    // publish the geolocation of the current user for other clients
                    publishPosition({
                        uuid: currUuid,
                        geoloc: pos
                    });

                    showUserData();

                    // console.log("Your current loc: " + pos.lat + " , " + pos.lng);
                }

                function handleLocationError(browserHasGeolocation) {
                    console.log(browserHasGeolocation ?
                        'Error: The Geolocation service failed.' :
                        'Error: Your browser doesn\'t support geolocation.'
                    );
                }

                function updatePosition(data) {
                    if (users.hasOwnProperty(data.uuid)) {
                        users[currUuid].geoloc = data.geoloc;
                    }
                }

                function publishPosition(data) {
                    pubnub.publish({
                        channel: MR_CHANNEL,
                        message: data
                    });
                }

                function initializeUsers(list) {
                    if (list.length > 0) {
                        for (var i=0; i < list.length; i++) {
                            users[list[i]['uuid']] = new User(list[i]['uuid'], {}, {});
                        }
                    } else {
                        console.log("No users is connected...")
                    }
                }

                function updateUsers(presence) {
                    if (presence) {
                        var newUuid = presence.uuid;
                        // if another user joins
                        if ((presence.action === "join") && (newUuid !== currUuid)) {
                            // update gloal user list
                            users[newUuid] = new User(newUuid, {}, {});
                        }
                        // if a user leaves
                        else if (presence.action === "timeout") {
                            delete users[presence.uuid]
                        }

                        $("#numUser").html(presence.occupancy);
                    }
                }

                function showUserData() {
                    var result = [];

                    for (var key in users) {
                        if (users.hasOwnProperty(key)) {
                            var userObj = users[key];
                            if (!jQuery.isEmptyObject(userObj) &&
                                userObj.uuid &&
                                !jQuery.isEmptyObject(userObj.geoloc)) {
                                var p = "<p>"+userObj.geoloc.lat+","+userObj.geoloc.lng+"</p>"
                                result.push(p);
                            } else {
                                result.push("<p>Not available</p>");
                            }
                        }
                    }

                    $("#userdata").html(result);
                }

                function generateUUID() {
                    var d = new Date().getTime();
                    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        var r = (d + Math.random()*16)%16 | 0;
                        d = Math.floor(d/16);
                        return (c=='x' ? r : (r&0x3|0x8)).toString(16);
                    });
                    return uuid;
                }
            }
        </script>
    </body>
</html>
