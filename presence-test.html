<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Test presence</title>
        <style>
            body {
            	font-family: Monospace;
            	background-color: #f0f0f0;
            	margin: 0px;
            	overflow: hidden;
            }

            #info {
                position: fixed;
                top: 0px;
                left: 0px;
                cursor: pointer;
                opacity: 0.9;
                z-index: 10000;
            }
        </style>
    </head>
    <body onload="justRunFam()">
        <!-- <div id="info">
            Current users: <span id="numUser">NaN</span>
            <div id="userdata"></div>
        </div> -->
        <div id="canvas"></div>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
        <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.0.5.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r79/three.min.js"></script>
        <script src="js/TrackballControls.js"></script>
        <script src="js/Detector.js"></script>
        <script type="text/javascript">
            /*
            Code sample from,
            https://www.pubnub.com/docs/javascript/api-reference-sdk-v4
            */
            class User {
                constructor(uuid, geoloc, position) {
                    this.uuid = uuid;
                    this.geoloc = geoloc;
                    this.position = position;
                }
            }

            var users = {};
            var currUuid = '';
            const MR_CHANNEL = 'mr-demo';
            const GEO_INTERVAL = 500;

            // geolocation config options
            const options = {
                timeout: (2 * 1000),
                maximumAge: 0,
                enableHighAccuracy: true
            };

            // for Threejs
            var userGeometries = {};
            var renderer;
            var scene, camera, controls, container, light;

            function justRunFam() {
                if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

                currUuid = generateUUID(); // generate a random id for the current user

                var pubnub = new PubNub({
                    publishKey: 'pub-c-d223f6bb-65ab-4128-b272-3984970759c1',
                    subscribeKey: 'sub-c-441be6a2-5d04-11e6-ada4-02ee2ddab7fe',
                    ssl: true,
                    uuid: currUuid,
                    heartbeatInterval: 5,
                    presenceTimeout: 60
                });

                pubnub.subscribe({
                    channels: [MR_CHANNEL],
                    withPresence: true
                });

                // View the UUID and state objects of those currently subscribed
                pubnub.hereNow(
                    {
                        channels: [MR_CHANNEL],
                        includeUUIDs: true,
                        includeState: true
                    },
                    function (status, response) {
                        // handle status, response
                        console.log("Here now:");
                        console.log(response);

                        if (response.channels[MR_CHANNEL]) {
                            var userList = response['channels'][MR_CHANNEL]['occupants'];
                            initializeUsers(userList);
                            initScene();
                        }
                    }
                );

                pubnub.addListener({
                    status: function(statusEvent) {
                        if (statusEvent.category === "PNConnectedCategory") {
                        }
                    },
                    message: function(m) {
                        var data = m.message;

                        if (!jQuery.isEmptyObject(data) &&
                            data.uuid &&
                            !jQuery.isEmptyObject(data.geoloc)) {

                            // update geolocation only for other users
                            if (data.uuid !== currUuid) updatePosition(data);
                        }
                    },
                    presence: function(e) {
                        updateUsers(e);
                    }
                });

                //////////////////////////
                // Get geolocation
                //////////////////////////
                setInterval(function(){
                    animate();
                    refreshGeolocation();
                }, GEO_INTERVAL);

                function initScene() {
                    container = $('#canvas');

                    camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.1, 10000 );
                    // place camera up and looking down
                    camera.position.set(0,100,200);
                    camera.up = new THREE.Vector3(0,0,0);
                    camera.lookAt(new THREE.Vector3(0,0,0));

    				controls = new THREE.TrackballControls( camera );

    				controls.rotateSpeed = 1.0;
    				controls.zoomSpeed = 1.2;
    				controls.panSpeed = 0.8;

                    // controls.staticMoving = true;
    				// controls.dynamicDampingFactor = 0.3;

    				controls.keys = [ 65, 83, 68 ];

    				controls.addEventListener( 'change', render );

                	scene = new THREE.Scene();

                    renderer = new THREE.WebGLRenderer( { antialias: false } );

                    // add a reference object
                    var ref = new THREE.CubeGeometry(4, 4, 4);
                    var refMat = new THREE.MeshLambertMaterial({color: 0xff0000});
                    var refMesh = new THREE.Mesh(ref, refMat);
                    refMesh.name = "reference";
                    refMesh.position.set(35,0,-85);
                    scene.add(refMesh);

                    // add grid helper
                    var gridHelper = new THREE.GridHelper( 100, 2 );
                    scene.add( gridHelper );

    				// construct scene and player objects
                    spawnCurrUsers();

                    // lights

    				light = new THREE.DirectionalLight( 0xffffff );
    				light.position.set( 1, 1, 1 );
    				scene.add( light );

    				light = new THREE.DirectionalLight( 0x002288 );
    				light.position.set( -1, -1, -1 );
    				scene.add( light );

    				light = new THREE.AmbientLight( 0x222222 );
    				scene.add( light );

                    // renderer

                    renderer.setClearColor( 0xffffff );
    				renderer.setPixelRatio( window.devicePixelRatio );
    				renderer.setSize( window.innerWidth, window.innerHeight );
                    container.append( renderer.domElement );

                    // render();
                }

                function animate() {
    				requestAnimationFrame( animate );
    				controls.update();
                    render();
    			}

    			function render() {
    				renderer.render( scene, camera );
    			}

                function spawnCurrUsers() {
                    for (var key in users) {
                        if (users.hasOwnProperty(key)) {
                            var userObj = users[key];
                            if (!jQuery.isEmptyObject(userObj) &&
                                userObj.uuid &&
                                !jQuery.isEmptyObject(userObj.geoloc)) {
                                spawnNewUser(userObj.uuid, userObj.geoloc);
                            } else {
                                spawnNewUser(userObj.uuid, {});
                            }
                        }
                    }
                }

                // takes a user id and create a new 3D object
                function spawnNewUser(uuid, geoloc) {
                    var sampleGeo = new THREE.SphereBufferGeometry( 2, 8, 6 );
                    // sampleGeo.translate(x,0,z);
                    var sampleMat = new THREE.MeshBasicMaterial( { color: Math.random()*0xffffff} );
                    var sampleMesh = new THREE.Mesh( sampleGeo, sampleMat );

                    sampleMesh.name = uuid;

                    if (!jQuery.isEmptyObject(geoloc)) {
                        var x = convertCoord(userObj.geoloc.lat);
                        var z = convertCoord(userObj.geoloc.lng);
                        sampleMesh.position.set(x,0,z);
                    }

                    // keep track of the global geometry list
                    // userGeometries[sampleMesh.name] = sampleMesh;

                    scene.add( sampleMesh );
                }

                function refreshGeolocation() {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(success, function() {
                            handleLocationError(true);
                        }, options);
                    } else {
                        // Browser doesn't support Geolocation
                        handleLocationError(false);
                    }
                }

                function success(position) {
                    var pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // update the geolocation of the current user
                    updatePosition({
                        uuid: currUuid,
                        geoloc: pos
                    });

                    // publish the geolocation of the current user for other clients
                    publishPosition({
                        uuid: currUuid,
                        geoloc: pos
                    });

                    // console.log("Your current loc: " + pos.lat + " , " + pos.lng);
                }

                function handleLocationError(browserHasGeolocation) {
                    console.log(browserHasGeolocation ?
                        'Error: The Geolocation service failed.' :
                        'Error: Your browser doesn\'t support geolocation.'
                    );
                }

                function updatePosition(data) {
                    if (users.hasOwnProperty(data.uuid)) {
                        var userObj = users[data.uuid];
                        userObj.geoloc = data.geoloc;

                        var x = convertCoord(userObj.geoloc.lat);
                        var z = convertCoord(userObj.geoloc.lng);

                        // update 3D object position
                        var target3DObj = scene.getObjectByName(userObj.uuid);
                        if (target3DObj) {
                            target3DObj.position.set(x, 0, z);
                        }
                    }
                }

                function publishPosition(data) {
                    pubnub.publish({
                        channel: MR_CHANNEL,
                        message: data
                    });
                }

                function initializeUsers(list) {
                    if (list.length > 0) {
                        for (var i=0; i < list.length; i++) {
                            users[list[i]['uuid']] = new User(list[i]['uuid'], {}, {});
                        }
                    } else {
                        console.log("No users is connected...")
                    }
                }

                function updateUsers(presence) {
                    if (presence) {
                        var newUuid = presence.uuid;
                        // if another user joins
                        if ((presence.action === "join") && (newUuid !== currUuid)) {
                            // update gloal user list
                            users[newUuid] = new User(newUuid, {}, {});

                            spawnNewUser(newUuid, {});
                        }
                        // if a user leaves
                        else if (presence.action === "timeout") {
                            delete users[newUuid]
                            // delete userGeometries[newUuid]
                            // remove scene object
                            scene.remove(scene.getObjectByName(newUuid));
                        }

                        // $("#numUser").html(presence.occupancy);
                    }
                }

                //////////////////////////
                // Utilities
                //////////////////////////

                function showUserData() {
                    // var result = [];
                    //
                    // for (var key in users) {
                    //     if (users.hasOwnProperty(key)) {
                    //         var userObj = users[key];
                    //         if (!jQuery.isEmptyObject(userObj) &&
                    //             userObj.uuid &&
                    //             !jQuery.isEmptyObject(userObj.geoloc)) {
                    //             var p = "<p>"+userObj.geoloc.lat+","+userObj.geoloc.lng+"</p>"
                    //             result.push(p);
                    //         } else {
                    //             result.push("<p>Not available</p>");
                    //         }
                    //     }
                    // }
                    //
                    // $("#userdata").html(result);
                }

                function generateUUID() {
                    var d = new Date().getTime();
                    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        var r = (d + Math.random()*16)%16 | 0;
                        d = Math.floor(d/16);
                        return (c=='x' ? r : (r&0x3|0x8)).toString(16);
                    });
                    return uuid;
                }

                function convertCoord(val) {
                    // return Math.floor(val/10.0);
                    var result = 0;
                    var strDeci = String(val % 1);

                    if (val >=0) {
                        var sixth = strDeci.charAt(7);
                        var seventh = strDeci.charAt(8);
                        var res = sixth + seventh;
                        result = Number(res);
                    } else {
                        var sixth = strDeci.charAt(6);
                        var seventh = strDeci.charAt(7);
                        var res = sixth + seventh;
                        result = Number(res);
                    }
                    return result;
                }
            }
        </script>
    </body>
</html>
